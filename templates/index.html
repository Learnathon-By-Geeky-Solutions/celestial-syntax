{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header mb-5">
    <h1 class="display-5 fw-bold text-dark mb-3">Attendance Dashboard</h1>

    {# Flash Messages Section #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row g-4">
        {# Facial Recognition Card #}
        <div class="col-lg-4 col-md-6">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary p-3 rounded-circle me-3 shadow-sm">
                            <i class="fas fa-camera text-white fa-lg"></i>
                        </div>
                        <h4 class="mb-0 card-title">Facial Recognition</h4>
                    </div>
                    <p class="text-muted">Start/stop attendance recording using live facial recognition.</p>
                    <div class="mt-auto d-grid gap-2">
                        <a href="/take_attendance" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>Start Session
                        </a>
                        <a href="/register" class="btn btn-secondary">
                            <i class="fas fa-user-plus me-2"></i>Register New Face
                        </a>
                        <form action="/stop_attendance" method="POST" class="d-grid">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="fas fa-stop me-2"></i>Stop Session
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# Reports & Analytics Card (Improved with Stats) #}
        <div class="col-lg-4 col-md-6">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-success p-3 rounded-circle me-3 shadow-sm">
                            <i class="fas fa-chart-line text-white fa-lg"></i>
                        </div>
                        <h4 class="mb-0 card-title">Reports & Analytics</h4>
                    </div>
                    <p class="text-muted">View overall attendance statistics, trends, and course-specific reports.</p>

                    {# Display Stats calculated in app.py index route #}
                    <div class="text-center my-3 flex-grow-1 d-flex flex-column justify-content-center">
                        {% if overall_percentage is not none and total_students is not none %}
                            <div class="mb-2">
                                <span class="display-6 fw-bold text-success">{{ overall_percentage }}%</span>
                                <span class="text-muted">Overall Attendance</span>
                            </div>
                            <div>
                                <span class="fw-bold">{{ total_students }}</span>
                                <span class="text-muted">Students Registered</span>
                            </div>
                        {% endif %}
                    </div>

                    <div class="mt-auto d-grid"> {# Changed from mt-auto to ensure button is at bottom #}
                        <a href="/reports" class="btn btn-success">
                            <i class="fas fa-eye me-2"></i>View Detailed Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {# Quick Lookups Card #}
        <div class="col-lg-4 col-md-12">
            <div class="card h-100">
                 <div class="card-body d-flex flex-column">
                     <div class="d-flex align-items-center mb-3">
                        <div class="bg-info p-3 rounded-circle me-3 shadow-sm">
                            <i class="fas fa-search text-white fa-lg"></i>
                        </div>
                        <h4 class="mb-0 card-title">Quick Lookups</h4>
                    </div>

                    {# Daily Report Form #}
                    <div class="mb-4 border-bottom pb-3">
                        <h6 class="text-muted"><i class="fas fa-calendar-day me-2"></i>Daily Report</h6>
                        <form method="POST" action="/attendance" class="mt-2">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label for="daily-date" class="form-label visually-hidden">Date</label>
                                    <input type="date" class="form-control form-control-sm" id="daily-date" name="selected_date" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="daily-course" class="form-label visually-hidden">Course</label>
                                    <select class="form-select form-select-sm" id="daily-course" name="course_id" required>
                                        <option value="" selected disabled>Select Course...</option>
                                        {% for course in courses %}
                                        <option value="{{ course.id }}">{{ course.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12 d-grid">
                                    <button type="submit" class="btn btn-info btn-sm">
                                        <i class="fas fa-search me-1"></i>View Daily
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    {# Student Semester Attendance Form #}
                    <div class="mb-3">
                        <h6 class="text-muted"><i class="fas fa-user-graduate me-2"></i>Student Semester Report</h6>
                        <form method="POST" action="/student_semester_attendance" class="mt-2">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label for="student-rollno" class="form-label visually-hidden">Roll Number</label>
                                    <input type="text" class="form-control form-control-sm" id="student-rollno" name="roll_number" placeholder="Enter Roll Number" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="student-semester" class="form-label visually-hidden">Semester</label>
                                    <select class="form-select form-select-sm" id="student-semester" name="semester" required>
                                        <option value="" selected disabled>Select Semester...</option>
                                        {# Populate semesters from the context variable #}
                                        {% for sem in semesters %}
                                        <option value="{{ sem }}">{{ sem }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12 d-grid">
                                    <button type="submit" class="btn btn-info btn-sm">
                                        <i class="fas fa-search me-1"></i>View Semester Attendance
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    {# End of Student Semester Attendance Form #}
                 </div>
            </div>
        </div>
    </div>

    {# Display Section for Daily Attendance Report #}
    {% if attendance_data %}
    <div class="report-section mt-5">
        <h4 class="mb-3">Daily Attendance: {{ selected_date }} - {{ selected_course_name or 'Selected Course' }}</h4>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="sortable-rollno cursor-pointer" onclick="sortTable(0, 'attendance-table-body')">
                                    Roll No.
                                    <i class="fas fa-sort ms-1" id="sort-icon-0"></i>
                                </th>
                                <th onclick="sortTable(1, 'attendance-table-body')">
                                    Student Name
                                     <i class="fas fa-sort ms-1" id="sort-icon-1"></i>
                                </th>
                                <th class="sortable-status cursor-pointer" onclick="sortTable(2, 'attendance-table-body')">
                                    Status
                                    <i class="fas fa-sort ms-1" id="sort-icon-2"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body">
                            {% for record in attendance_data %}
                            <tr>
                                <td>{{ record.roll_number }}</td>
                                <td>{{ record.name }}</td>
                                <td>
                                    <span class="status-badge {{ 'present' if record.present else 'absent' }}">
                                        {{ 'Present' if record.present else 'Absent' }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% elif no_data %}
     {# Optionally show a message if daily data was requested but not found #}
     {# <div class="alert alert-info mt-4">No daily attendance data found for the selected criteria.</div> #}
    {% endif %}

    {# Display Section for Student Semester Attendance Report (Improved Design) #}
    {% if student_lookup_data and not no_student_data %}
    <div class="report-section mt-5">
        <h4 class="mb-3">Semester Attendance Report</h4>
        <div class="card shadow-sm mb-4">
             {# Use bg-info to match Quick Lookups card #}
             <div class="card-header bg-info text-white">
                 <h5 class="mb-0">
                     <i class="fas fa-user-graduate me-2"></i>Student: {{ student_lookup_data.name }} ({{ student_lookup_data.roll_number }}) - Semester: {{ student_lookup_data.semester }}
                 </h5>
             </div>
             <div class="card-body">
                 {% if course_attendance_details %}
                 <div class="table-responsive">
                     {# Use table-hover and align-middle, removed borders/stripes #}
                     <table class="table table-hover align-middle mb-0">
                         {# Use table-light header like daily report #}
                         <thead class="table-light">
                             <tr>
                                 <th>Course Name</th>
                                 <th class="text-center">Total Classes</th>
                                 <th class="text-center">Classes Attended</th>
                                 <th class="text-center">Attendance %</th>
                             </tr>
                         </thead>
                         {# Give the body a unique ID for potential future sorting #}
                         <tbody id="semester-attendance-table-body">
                             {% for course in course_attendance_details %}
                             <tr>
                                 <td>{{ course.course_name }}</td>
                                 <td class="text-center">{{ course.total_classes }}</td>
                                 <td class="text-center">{{ course.classes_attended }}</td>
                                 {# Use progress bar for percentage #}
                                 <td>
                                     {% set percentage = course.percentage %}
                                     {% set bar_color = 'bg-success' %} {# Default green #}
                                     {% if percentage < 50 %}
                                         {% set bar_color = 'bg-danger' %} {# Red #}
                                     {% elif percentage < 75 %}
                                         {% set bar_color = 'bg-warning' %} {# Yellow #}
                                     {% endif %}
                                     <div class="progress" style="height: 20px; font-size: 0.85em;">
                                         <div class="progress-bar {{ bar_color }}" role="progressbar"
                                              style="width: {{ percentage }}%"
                                              aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100">
                                             {{ percentage }}%
                                         </div>
                                     </div>
                                 </td>
                             </tr>
                             {% endfor %}
                         </tbody>
                     </table>
                 </div>
                 {% else %}
                 <p class="text-muted mb-0 text-center py-3">
                     <i class="fas fa-info-circle me-1"></i>No attendance records found for this student in the selected semester.
                 </p>
                 {% endif %}
             </div>
        </div>
    </div>
    {% elif no_student_data %}
        {# Optionally show a message if student data was requested but not found/error occurred #}
        {# This is usually handled by the flash message, but you could add another indicator here if needed #}
        {# <div class="alert alert-warning mt-4">Could not retrieve student semester data.</div> #}
    {% endif %}
    {# End of Student Semester Attendance Display #}

</div> {# End of dashboard-header #}

<script>
    // --- Table Sorting Logic ---
    let sortDirections = {}; // Store sort direction for each table body ID + column index

    function sortTable(columnIndex, tableBodyId) {
        const tableBody = document.getElementById(tableBodyId);
        if (!tableBody) return; // Exit if table body not found

        const rows = Array.from(tableBody.querySelectorAll('tr'));
        if (rows.length === 0) return; // Exit if no rows to sort

        const sortKey = `${tableBodyId}-${columnIndex}`; // Unique key for sorting state

        // Determine current sort direction for the clicked column, default to 'asc'
        const currentDirection = sortDirections[sortKey] || 'asc';
        // Toggle direction
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';

        // Reset directions for *this table's* columns, set for the current one
        const table = tableBody.closest('table'); // Find the parent table
        if (!table) return;
        const headers = table.querySelectorAll('thead th[onclick^="sortTable"]');

        headers.forEach((header, index) => {
            const headerSortKey = `${tableBodyId}-${index}`;
             if (headerSortKey !== sortKey) {
                 delete sortDirections[headerSortKey]; // Reset other columns in this table
             }
        });
         sortDirections[sortKey] = newDirection; // Set current column direction


        // Update sort icons visually within the correct table header
        headers.forEach((header, index) => {
             const icon = header.querySelector('i.fas');
             if (icon) {
                 icon.classList.remove('fa-sort-up', 'fa-sort-down', 'fa-sort'); // Remove all sort classes
                 if (index === columnIndex) {
                     // Add the correct icon based on the new direction
                     icon.classList.add(newDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                 } else {
                     // Add the neutral sort icon for other columns in this table
                     icon.classList.add('fa-sort');
                 }
             }
        });

        // Sort the rows
        rows.sort((rowA, rowB) => {
            const cellAElement = rowA.querySelectorAll('td')[columnIndex];
            const cellBElement = rowB.querySelectorAll('td')[columnIndex];
            if (!cellAElement || !cellBElement) return 0; // Skip if cells don't exist

            const cellA = cellAElement.textContent.trim();
            const cellB = cellBElement.textContent.trim();


            let comparison = 0;

            // --- Customize sorting based on table and column ---
            if (tableBodyId === 'attendance-table-body') { // Daily Attendance Table
                if (columnIndex === 0) { // Roll No
                    const numA = parseInt(cellA.replace(/[^0-9]/g, ''), 10);
                    const numB = parseInt(cellB.replace(/[^0-9]/g, ''), 10);
                    comparison = (isNaN(numA) ? 0 : numA) - (isNaN(numB) ? 0 : numB);
                } else if (columnIndex === 2) { // Status
                    comparison = (cellA === 'Present' ? -1 : 1) - (cellB === 'Present' ? -1 : 1);
                } else { // Student Name (default string)
                    comparison = cellA.localeCompare(cellB);
                }
            }
            // Add sorting logic for semester table if needed (e.g., sort by percentage)
            else if (tableBodyId === 'semester-attendance-table-body') {
                 if (columnIndex === 3) { // Attendance % column
                     // Extract percentage from progress bar or text - Need to access aria-valuenow
                     const progressBarA = rowA.querySelector('td:nth-child(4) .progress-bar');
                     const progressBarB = rowB.querySelector('td:nth-child(4) .progress-bar');
                     const percentA = parseFloat(progressBarA ? progressBarA.getAttribute('aria-valuenow') : 0) || 0;
                     const percentB = parseFloat(progressBarB ? progressBarB.getAttribute('aria-valuenow') : 0) || 0;
                     comparison = percentA - percentB;
                 } else if (columnIndex === 1 || columnIndex === 2) { // Total Classes or Attended (numeric)
                     const numA = parseInt(cellA, 10) || 0;
                     const numB = parseInt(cellB, 10) || 0;
                     comparison = numA - numB;
                 }
                 else { // Course Name (default string)
                     comparison = cellA.localeCompare(cellB);
                 }
            }
            else { // Default string comparison if no specific logic
                 comparison = cellA.localeCompare(cellB);
            }


            // Apply direction multiplier
            return newDirection === 'asc' ? comparison : -comparison;
        });

        // Clear the table body and re-append sorted rows
        tableBody.innerHTML = '';
        rows.forEach(row => tableBody.appendChild(row));
    }

     // Initialize sort icons on page load for all sortable tables
    document.addEventListener('DOMContentLoaded', () => {
         document.querySelectorAll('th[onclick^="sortTable"] i.fas').forEach(icon => {
            icon.classList.add('fa-sort'); // Add the neutral sort icon initially
        });
    });
</script>
{% endblock %}
